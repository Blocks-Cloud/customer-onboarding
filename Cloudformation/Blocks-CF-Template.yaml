AWSTemplateFormatVersion: "2010-09-09"
Description: >
  IMPORTANT:

  Deploy this stack in your AWS Organization Management (root) account in the us-east-1 region only.


  SUMMARY:

  This CloudFormation template automates the ingestion of AWS Cost and Usage Report (CUR 2.0) data, and grants Blocks secure, read-only access to perform cost optimization analysis across all linked accounts:
  Configures CUR 2.0 exports with hourly granularity.
  Creates an S3 bucket to store CUR 2.0 data in Parquet format.
  Automatically starts a cost allocation tag to backfill up to 12 months of historical data.
  Creates a read-only IAM role to selected AWS services.
  Creates an IAM role with limited support access and opens an AWS Support case on your behalf to backfill up to 36 months of historical data.
  Deploys read-only roles to all linked accounts via the StackSet CloudFormation template to gain organization-wide cost visibility.

Metadata:
  TemplateVersion: "1.3.0"
  LastUpdated: "2025-12-09"

Parameters:
  OrganizationRootId:
    Type: String
    Description: "AWS Organization Root OU ID (e.g., r-xxxx). Find this in AWS Organizations console."
    AllowedPattern: "^r-[a-z0-9]{4,32}$"
    ConstraintDescription: "Must be a valid Organization Root ID starting with r-"

Rules:
  EnforceUsEast1:
    Assertions:
      - Assert:
          Fn::Equals:
            - !Ref AWS::Region
            - us-east-1
        AssertDescription: "You must deploy to region us-east-1 only. Since Data exports is only available in us-east-1"

Resources:
  CostAllocationBackfillLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CostAllocationBackfillLambdaPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ce:StartCostAllocationTagBackfill
                  - ce:UpdateCostAllocationTagsStatus
                  - ce:ListCostAllocationTagBackfillHistory
                  - ce:ListCostAllocationTags
                Resource: "*"

  CURBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "blocks-cur-data-${AWS::AccountId}"
      OwnershipControls:
        Rules: [{ ObjectOwnership: BucketOwnerEnforced }]
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Status: Enabled
            ExpirationInDays: 365
            NoncurrentVersionExpirationInDays: 30
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 30
      VersioningConfiguration: { Status: Enabled }
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - { ServerSideEncryptionByDefault: { SSEAlgorithm: AES256 } }

  CURBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CURBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowBCMDataExportsPut
            Effect: Allow
            Principal: { Service: bcm-data-exports.amazonaws.com }
            Action: s3:PutObject
            Resource: !Sub "arn:${AWS::Partition}:s3:::${CURBucket}/*"
            Condition:
              StringEquals: { aws:SourceAccount: !Ref AWS::AccountId }
              StringLike:
                aws:SourceArn: !Sub "arn:${AWS::Partition}:bcm-data-exports:us-east-1:${AWS::AccountId}:export/*"

          - Sid: AllowBCMDataExportsBucketMeta
            Effect: Allow
            Principal: { Service: bcm-data-exports.amazonaws.com }
            Action:
              - s3:GetBucketAcl
              - s3:GetBucketPolicy
              - s3:GetBucketLocation
              - s3:ListBucket
            Resource: !Sub "arn:${AWS::Partition}:s3:::${CURBucket}"
            Condition:
              StringEquals: { aws:SourceAccount: !Ref AWS::AccountId }
              StringLike:
                aws:SourceArn: !Sub "arn:${AWS::Partition}:bcm-data-exports:us-east-1:${AWS::AccountId}:export/*"

          - Sid: AllowReadRoleListBucket
            Effect: Allow
            Principal:
              AWS: !GetAtt BlocksReadRole.Arn
            Action: "s3:ListBucket"
            Resource: !Sub "arn:${AWS::Partition}:s3:::${CURBucket}"
            Condition:
              StringLike:
                s3:prefix: ["cur2/*"]
          - Sid: AllowReadRoleGetObject
            Effect: Allow
            Principal:
              AWS: !GetAtt BlocksReadRole.Arn
            Action: "s3:GetObject"
            Resource: !Sub "arn:${AWS::Partition}:s3:::${CURBucket}/cur2/*"

  Cur20Export:
    Type: AWS::BCMDataExports::Export
    DependsOn: CURBucketPolicy
    Properties:
      Export:
        Name: !Sub "blocks-cur-data-${AWS::AccountId}"
        Description: "CUR 2.0 export to S3 (Parquet), hourly with resource IDs"
        DataQuery:
          QueryStatement: |
            SELECT bill_bill_type, 
              bill_billing_entity, 
              bill_billing_period_end_date, 
              bill_billing_period_start_date, 
              bill_invoice_id, 
              bill_invoicing_entity, 
              bill_payer_account_id,
              bill_payer_account_name, 
              cost_category, 
              discount, 
              discount_bundled_discount, 
              discount_total_discount, 
              identity_line_item_id, 
              identity_time_interval, 
              line_item_availability_zone, 
              line_item_blended_cost, 
              line_item_blended_rate, 
              line_item_currency_code, 
              line_item_legal_entity, 
              line_item_line_item_description, 
              line_item_line_item_type, 
              line_item_net_unblended_cost, 
              line_item_net_unblended_rate, 
              line_item_normalization_factor, 
              line_item_normalized_usage_amount, 
              line_item_operation, 
              line_item_product_code, 
              line_item_resource_id, 
              line_item_tax_type, 
              line_item_unblended_cost, 
              line_item_unblended_rate, 
              line_item_usage_account_id, 
              line_item_usage_account_name, 
              line_item_usage_amount, 
              line_item_usage_end_date, 
              line_item_usage_start_date, 
              line_item_usage_type, 
              pricing_currency, 
              pricing_lease_contract_length, 
              pricing_offering_class, 
              pricing_public_on_demand_cost, 
              pricing_public_on_demand_rate, 
              pricing_purchase_option, 
              pricing_rate_code, 
              pricing_rate_id, 
              pricing_term, 
              pricing_unit, 
              product, 
              product_comment, 
              product_fee_code, 
              product_fee_description, 
              product_from_location, 
              product_from_location_type, 
              product_from_region_code, 
              product_instance_family,
              product_instance_type, 
              product_instancesku, 
              product_location, 
              product_location_type,
              product_operation, 
              product_pricing_unit, 
              product_product_family, 
              product_region_code,
              product_servicecode,
              product_sku,
              product_to_location, 
              product_to_location_type,
              product_to_region_code, 
              product_usagetype, 
              reservation_amortized_upfront_cost_for_usage, 
              reservation_amortized_upfront_fee_for_billing_period, 
              reservation_availability_zone, 
              reservation_effective_cost, 
              reservation_end_time, 
              reservation_modification_status, 
              reservation_net_amortized_upfront_cost_for_usage, 
              reservation_net_amortized_upfront_fee_for_billing_period, 
              reservation_net_effective_cost, 
              reservation_net_recurring_fee_for_usage,
              reservation_net_unused_amortized_upfront_fee_for_billing_period, 
              reservation_net_unused_recurring_fee,
              reservation_net_upfront_value,
              reservation_normalized_units_per_reservation,
              reservation_number_of_reservations,
              reservation_recurring_fee_for_usage,
              reservation_reservation_a_r_n,
              reservation_start_time,
              reservation_subscription_id,
              reservation_total_reserved_normalized_units,
              reservation_total_reserved_units,
              reservation_units_per_reservation,
              reservation_unused_amortized_upfront_fee_for_billing_period,
              reservation_unused_normalized_unit_quantity,
              reservation_unused_quantity,
              reservation_unused_recurring_fee,
              reservation_upfront_value,
              resource_tags,
              savings_plan_amortized_upfront_commitment_for_billing_period,
              savings_plan_end_time,
              savings_plan_instance_type_family,
              savings_plan_net_amortized_upfront_commitment_for_billing_period,
              savings_plan_net_recurring_commitment_for_billing_period,
              savings_plan_net_savings_plan_effective_cost,
              savings_plan_offering_type,
              savings_plan_payment_option,
              savings_plan_purchase_term,
              savings_plan_recurring_commitment_for_billing_period,
              savings_plan_region,
              savings_plan_savings_plan_a_r_n,
              savings_plan_savings_plan_effective_cost,
              savings_plan_savings_plan_rate,
              savings_plan_start_time,
              savings_plan_total_commitment_to_date,
              savings_plan_used_commitment,
              split_line_item_actual_usage,
              split_line_item_net_split_cost,
              split_line_item_net_unused_cost,
              split_line_item_parent_resource_id,
              split_line_item_public_on_demand_split_cost,
              split_line_item_public_on_demand_unused_cost,
              split_line_item_reserved_usage,
              split_line_item_split_cost,
              split_line_item_split_usage,
              split_line_item_split_usage_ratio,
              split_line_item_unused_cost
            FROM COST_AND_USAGE_REPORT
          TableConfigurations:
            COST_AND_USAGE_REPORT:
              INCLUDE_MANUAL_DISCOUNT_COMPATIBILITY: "FALSE"
              TIME_GRANULARITY: "HOURLY"
              INCLUDE_RESOURCES: "TRUE"
              INCLUDE_SPLIT_COST_ALLOCATION_DATA: "TRUE"
        DestinationConfigurations:
          S3Destination:
            S3Bucket: !Ref CURBucket
            S3Prefix: "cur2"
            S3Region: !Ref AWS::Region
            S3OutputConfigurations:
              Compression: PARQUET
              Format: PARQUET
              OutputType: CUSTOM
              Overwrite: OVERWRITE_REPORT
        RefreshCadence: { Frequency: SYNCHRONOUS }

  EnableCostAllocationBackfillLambda:
    Type: AWS::Lambda::Function
    DependsOn: Cur20Export
    Description: "Lambda function to enable Cost Allocation Backfill"
    Properties:
      FunctionName: EnableCostAllocationBackfill
      Runtime: python3.11
      Handler: index.handler
      Role: !GetAtt CostAllocationBackfillLambdaRole.Arn
      Timeout: 60
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          import time
          import datetime
          from botocore.exceptions import ClientError
          def handler(event, context):
            print("Received event:", event)
            ce = boto3.client("ce")
            try:  
                if event['RequestType'] in ['Create', 'Update']:
                    print("Checking for existing backfills...")
                    try:
                        backfill_history = ce.list_cost_allocation_tag_backfill_history()
                        if any(b['BackfillStatus'] == 'PROCESSING' for b in backfill_history.get('BackfillHistory', [])):
                            print("A backfill is already processing. Skipping new request.")
                            cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                            return
                    except Exception as e:
                        print(f"Warning: Could not list backfill history: {e}")

                    print("Attempting to activate Cost Allocation Backfill...")
                    
                    current_date = datetime.datetime.utcnow()
                    backfill_from = datetime.datetime(
                        current_date.year - 1, 
                        current_date.month, 
                        1, 
                        0, 
                        0, 
                        0
                    )
                    print(f"Backfill from: {backfill_from.strftime('%Y-%m-%dT%H:%M:%SZ')}")

                    target_tag_key = 'aws:createdBy'
                    
                    try:
                        # Check status of aws:createdBy
                        response = ce.list_cost_allocation_tags(
                            TagKeys=[target_tag_key],
                            Type='AWSGenerated'
                        )
                        
                        is_active = False
                        for tag in response.get('CostAllocationTags', []):
                            if tag['TagKey'] == target_tag_key and tag['Status'] == 'Active':
                                is_active = True
                                break
                        
                        if is_active:
                            print(f"Tag {target_tag_key} is already Active. Searching for another inactive AWS-managed tag...")
                            
                            # List AWS generated tags to find a substitute
                            all_tags_response = ce.list_cost_allocation_tags(
                                MaxResults=50
                            )
                            
                            for tag in all_tags_response.get('CostAllocationTags', []):
                                if tag['Status'] == 'Inactive':
                                    target_tag_key = tag['TagKey']
                                    print(f"Found inactive tag to activate: {target_tag_key}")
                                    break
                                    
                    except Exception as e:
                        print(f"Error checking tag status: {str(e)}")

                    print(f"Activating tag: {target_tag_key}")

                    ce.update_cost_allocation_tags_status(
                        CostAllocationTagsStatus=[
                            {
                                'TagKey': target_tag_key,
                                'Status': 'Active'
                            }
                        ]
                    )
                    response = ce.start_cost_allocation_tag_backfill(
                        BackfillFrom=backfill_from.strftime("%Y-%m-%dT%H:%M:%SZ")
                    )
                    print(f"Backfill response: {response}")
                    print("Cost Allocation Backfill requested successfully.")
                        
                cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
            except Exception as e:
                print("Error:", e)
                cfnresponse.send(event, context, cfnresponse.FAILED, {"Error": str(e)})

  EnableCostAllocationBackfill:
    Type: Custom::EnableCostAllocationBackfill
    Properties:
      ServiceToken: !GetAtt EnableCostAllocationBackfillLambda.Arn

  SubAccountStackSet:
    Type: AWS::CloudFormation::StackSet
    Properties:
      StackSetName: "Subaccounts-Blocks-IAM-Read-Role"
      Description: "Deploys the Blocks read-only IAM role to all member accounts for organization-wide cost analysis and optimization"
      PermissionModel: SERVICE_MANAGED
      AutoDeployment:
        Enabled: true
        RetainStacksOnAccountRemoval: false
      Capabilities:
        - CAPABILITY_NAMED_IAM
      TemplateURL: "https://blocks-cf-templates.s3.eu-north-1.amazonaws.com/Blocks-CF-Subaccounts-Template.yaml"
      StackInstancesGroup:
        - DeploymentTargets:
            OrganizationalUnitIds:
              - !Ref OrganizationRootId
          Regions:
            - us-east-1
      OperationPreferences:
        FailureTolerancePercentage: 0
        MaxConcurrentPercentage: 100
        RegionConcurrencyType: PARALLEL
      Tags:
        - Key: TemplateVersion
          Value: "1.0.0"
      CallAs: SELF

  BlocksCostAndReservationsReadPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: "BlocksCostAndReservationsReadPolicy"
      Description: "Used by Blocks.cloud. Must remain in place for Blocks to function correctly. Email support@blocks.cloud for assistance. Read-only access to Cost Explorer, billing, CUR, and reserved instance data for cost analysis."
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          # Cost and usage analytics APIs
          # Services: Cost Explorer, Cost Optimization Hub, CUR, BCM Data Exports
          - Sid: CostAndUsageReadOnly
            Effect: Allow
            Action:
              - ce:Get*
              - ce:List*
              - ce:Describe*
              - cost-optimization-hub:Get*
              - cost-optimization-hub:List*
              - cur:Get*
              - cur:DescribeReportDefinitions
              - bcm-data-exports:GetExport
              - bcm-data-exports:ListExports
            Resource: "*"

          # Billing data, discounts, and credits
          # Services: AWS Billing
          - Sid: PpaAndCreditsCheck
            Effect: Allow
            Action:
              - billing:GetBillingData
              - billing:GetBillingDetails
              - billing:GetCredits
            Resource: "*"

          # Reserved instance inventory
          # Services: EC2, RDS, Redshift, ElastiCache
          - Sid: ReservationsReadOnly
            Effect: Allow
            Action:
              - elasticache:DescribeReserved*
              - redshift:DescribeReserved*
              - rds:DescribeReserved*
              - ec2:DescribeReserved*
            Resource: "*"

  BlocksSavingsEstimationReadOnlyPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: "BlocksSavingsEstimationReadOnlyPolicy"
      Description: "Used by Blocks.cloud. Must remain in place for Blocks to function correctly. Email support@blocks.cloud for assistance. Read-only access to configuration and usage data across compute, storage, database, and monitoring services for savings analysis."
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          # Compute, scaling, and load balancing
          # Services: EC2, Auto Scaling, Application Auto Scaling, ELB, Lambda, Batch, App Runner
          - Sid: ComputeAndScalingReadOnly
            Effect: Allow
            Action:
              - ec2:Describe*
              - ec2:Get*
              - ec2:List*
              - dlm:Get*
              - elasticloadbalancing:Describe*
              - autoscaling:Describe*
              - autoscaling:Get*
              - autoscaling:List*
              - application-autoscaling:Describe*
              - application-autoscaling:List*
              - application-autoscaling:Get*
              - autoscaling-plans:Describe*
              - autoscaling-plans:Get*
              - lambda:List*
              - lambda:Get*
              - batch:Get*
              - batch:List*
              - apprunner:ListServices
              - apprunner:DescribeService
              - apprunner:ListAutoScalingConfigurations
              - apprunner:DescribeAutoScalingConfiguration
              - apprunner:ListTagsForResource
            Resource: "*"

          # Containers, orchestration, and build/deploy
          # Services: ECS, EKS, ECR, CodeBuild, CodePipeline
          - Sid: ContainersAndBuildReadOnly
            Effect: Allow
            Action:
              - ecs:List*
              - ecs:Describe*
              - eks:List*
              - eks:Describe*
              - ecr:DescribeRepositories
              - ecr:ListImages
              - ecr:DescribeImages
              - codebuild:ListProjects
              - codebuild:BatchGetProjects
              - codebuild:ListBuilds
              - codebuild:ListBuildsForProject
              - codebuild:ListTagsForResource
              - codepipeline:GetPipeline
              - codepipeline:ListPipelines
              - codepipeline:ListTagsForResource
            Resource: "*"

          # Databases and caching
          # Services: RDS, DynamoDB, DAX, Redshift, Redshift Serverless, ElastiCache, MemoryDB, Neptune, Aurora DSQL
          - Sid: DatabasesAndCachingReadOnly
            Effect: Allow
            Action:
              - rds:Describe*
              - rds:List*
              - dynamodb:List*
              - dynamodb:Describe*
              - dax:DescribeClusters
              - dax:ListTags
              - dax:DescribeDefaultParameters
              - dax:DescribeParameters
              - redshift:Describe*
              - redshift:Get*
              - redshift:List*
              - redshift-serverless:Describe*
              - redshift-serverless:List*
              - elasticache:Describe*
              - elasticache:List*
              - memorydb:Describe*
              - memorydb:List*
              - memorydb:ListTags
              - dsql:Get*
              - dsql:List*
              - neptune:DescribeDBClusters
              - neptune:DescribeDBInstances
              - neptune:DescribeDBClusterSnapshots
              - neptune:DescribeDBParameterGroups
              - neptune:DescribeDBClusterParameterGroups
              - neptune:ListTagsForResource
              - neptune-graph:GetEngineStatus
              - neptune-graph:GetGraphSummary
              - neptune-db:GetEngineStatus
              - neptune-db:GetGraphSummary
            Resource: "*"

          # Streaming, messaging, and analytics
          # Services: Kinesis, Kinesis Data Analytics, Firehose, Timestream, Timestream InfluxDB
          - Sid: StreamingAndAnalyticsReadOnly
            Effect: Allow
            Action:
              - timestream:List*
              - timestream:Describe*
              - timestream:ListTagsForResource
              - timestream-influxdb:Get*
              - timestream-influxdb:List*
              - kinesis:ListShards
              - kinesis:ListStreamConsumers
              - kinesis:ListStreams
              - kinesis:DescribeLimits
              - kinesis:DescribeStreamConsumer
              - kinesis:DescribeStreamSummary
              - kinesis:ListTagsForResource
              - kinesisanalytics:ListApplications
              - kinesisanalytics:DescribeApplication
              - kinesisanalytics:ListTagsForResource
              - firehose:ListDeliveryStreams
              - firehose:DescribeDeliveryStream
              - firehose:ListTagsForDeliveryStream
            Resource: "*"

          # AI, ML, data platforms, and dashboards
          # Services: SageMaker, Glue, Bedrock, Airflow (MWAA)
          - Sid: DataPlatformsAndAiReadOnly
            Effect: Allow
            Action:
              - sagemaker:Describe*
              - sagemaker:List*
              - sagemaker:Search
              - Glue:Get*
              - Glue:List*
              - bedrock:GetProvisionedModelThroughput
              - bedrock:ListProvisionedModelThroughputs
              - airflow:ListEnvironments
              - airflow:GetEnvironment
              - airflow:ListTagsForResource
            Resource: "*"

          # Storage, backup, and content delivery
          # Services: S3 (metadata only), FSx, EFS, Backup
          - Sid: StorageAndContentReadOnly
            Effect: Allow
            Action:
              - s3:List*
              - s3vectors:ListVectorBuckets
              - s3:GetLifecycleConfiguration
              - s3:GetBucketLocation
              - s3:GetObjectRetention
              - s3:GetBucketTagging
              - fsx:Describe*
              - fsx:List*
              - elasticfilesystem:Describe*
              - elasticfilesystem:List*
              - backup:Describe*
              - backup:Get*
              - backup:List*
            Resource: "*"

          # Networking, API management, and security edges
          # Services: API Gateway, OpenSearch / ES, WAFv2, CloudFront
          - Sid: NetworkAndEdgeReadOnly
            Effect: Allow
            Action:
              - apigateway:GET
              - es:Describe*
              - es:List*
              - es:Get*
              - wafv2:ListWebACLs
              - wafv2:GetWebACL
              - wafv2:GetWebACLForResource
              - wafv2:ListResourcesForWebACL
              - wafv2:ListTagsForResource
              - cloudfront:Get*
              - cloudfront:List*
            Resource: "*"

          # End-user compute and application streaming
          # Services: WorkSpaces, AppStream
          - Sid: EndUserServicesReadOnly
            Effect: Allow
            Action:
              - workspaces:Describe*
              - appstream:Describe*
              - appstream:List*
            Resource: "*"

          # Monitoring, observability, and advisory services
          # Services: CloudWatch, CloudWatch Logs, Grafana, OAM, Trusted Advisor, AWS Support
          - Sid: ObservabilityAndAdvisoryReadOnly
            Effect: Allow
            Action:
              - cloudwatch:Describe*
              - cloudwatch:Get*
              - cloudwatch:List*
              - oam:ListSinks
              - logs:Describe*
              - logs:Get*
              - logs:List*
              - grafana:ListWorkspaces
              - grafana:DescribeWorkspace
              - grafana:DescribeWorkspaceConfiguration
              - grafana:ListTagsForResource
              - trustedadvisor:Describe*
              - trustedadvisor:Get*
              - trustedadvisor:List*
              - support:DescribeTrustedAdvisorChecks
              - support:DescribeTrustedAdvisorCheckResult
              - support:DescribeTrustedAdvisorCheckSummaries
              - support:DescribeTrustedAdvisorCheckRefreshStatuses
              - support:RefreshTrustedAdvisorCheck
            Resource: "*"

          # IAM Identity Center ReadOnly
          - Sid: IamIdentityCenterReadOnly
            Effect: Allow
            Action:
              - sso:ListInstances
            Resource: "*"

  BlocksReadRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "BlocksReadRole"
      Description: "Used by Blocks.cloud. Must remain in place for Blocks to function correctly. Email support@blocks.cloud for assistance."
      MaxSessionDuration: 3600
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:${AWS::Partition}:iam::810801871908:role/BlocksCustomerAccessRole"
            Action:
              - sts:AssumeRole
            Condition:
              StringEquals:
                "sts:ExternalId": "blocks-shared-secret"
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:${AWS::Partition}:iam::810801871908:role/BlocksCustomerAccessRole"
            Action:
              - sts:TagSession

      ManagedPolicyArns:
        - !Ref BlocksCostAndReservationsReadPolicy
        - !Ref BlocksSavingsEstimationReadOnlyPolicy
        - !Sub arn:${AWS::Partition}:iam::aws:policy/ComputeOptimizerReadOnlyAccess
        - !Sub arn:${AWS::Partition}:iam::aws:policy/AWSOrganizationsReadOnlyAccess
        - !Sub arn:${AWS::Partition}:iam::aws:policy/AWSSavingsPlansReadOnlyAccess
        - !Sub arn:${AWS::Partition}:iam::aws:policy/AWSResourceGroupsReadOnlyAccess

  CreateBackfillSupportCaseRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "CreateBackfillSupportCaseRole"
      Description: "Used by Blocks.cloud to create a support case to backfill CUR 2.0 data"
      MaxSessionDuration: 3600
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:${AWS::Partition}:iam::810801871908:role/BlocksCustomerAccessRole"
            Action: "sts:AssumeRole"

      Policies:
        - PolicyName: CreateBackfillSupportCasePermissions
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - support:CreateCase
                  - support:DescribeCases
                  - support:DescribeServices
                  - support:DescribeCommunications
                  - support:DescribeSeverityLevels
                  - support:DescribeCreateCaseOptions
                Resource: "*"
              - Sid: DenyAfterExpiryDate
                Effect: Deny
                Action: "*"
                Resource: "*"
                Condition:
                  DateGreaterThan:
                    aws:CurrentTime: "2026-03-31T23:59:59Z"

  BlocksNotifierRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "BlocksNotifierRole"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: SendToBlocksSQS
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource: "arn:aws:sqs:us-east-1:810801871908:Blocks-Onboarding-Queue"

  CloudFormationCompleteRule:
    Type: AWS::Events::Rule
    Properties:
      Name: "NotifyBlocksStackComplete"
      EventPattern:
        source:
          - "aws.cloudformation"
        detail-type:
          - "CloudFormation Stack Status Change"
      Targets:
        - Arn: "arn:aws:sqs:us-east-1:810801871908:Blocks-Onboarding-Queue"
          Id: "SendToBlocksSQS"
          RoleArn: !GetAtt BlocksNotifierRole.Arn

Outputs:
  CURBucketName:
    Description: "S3 bucket where CUR 2.0 data is stored"
    Value: !Ref CURBucket
  CURBucketArn:
    Description: "ARN of the S3 bucket where CUR 2.0 data is stored"
    Value: !Sub "arn:${AWS::Partition}:s3:::${CURBucket}"
  Cur20ExportName:
    Description: "Name of the CUR 2.0 export"
    Value: !Ref Cur20Export
  BlocksReadRoleArn:
    Description: "Read-only cross-account role ARN. Return this role ARN to Blocks to complete the setup"
    Value: !GetAtt BlocksReadRole.Arn
  BlocksReadRoleName:
    Description: "Cross-account role Name with read-only access to CUR S3 data, billing services, and 40+ AWS services for complete cost visibility and optimization"
    Value: !Ref BlocksReadRole
  CreateBackfillSupportCaseRoleArn:
    Description: "Cross-account role ARN to create a support case to backfill up to 36 months of historical CUR data"
    Value: !GetAtt CreateBackfillSupportCaseRole.Arn
  CreateBackfillSupportCaseRoleName:
    Description: "Cross-account role Name to create a support case to backfill up to 36 months of historical CUR data"
    Value: !Ref CreateBackfillSupportCaseRole
  NextSteps:
    Description: "Instructions for completing setup"
    Value: !Sub |
      Setup Complete!

      Blocks will automatically create an AWS Support case to backfill up to 36 months of historical CUR data.

      Note: This role will automatically expire on 31st March 2026 for security.
