AWSTemplateFormatVersion: '2010-09-09'
Description: >
  This Blocks CloudFormation template automates the deployment of AWS Cost and Usage Report (CUR 2.0) with comprehensive read-only access for cost optimization and analysis.
  It creates an S3 bucket for hourly cost data exports in Parquet format, configures a detailed CUR 2.0 export with 140+ billing fields including resource IDs and split cost allocation, requests historical data backfill via AWS Support. 
  It establishes a secure cross-account IAM role that can be assumed by Blocks with read-only permissions across 40+ AWS services (compute, storage, databases, analytics, networking, and cost management) and deploys read-only roles to all sub-accounts via StackSet for organization-wide visibility.'
  The Template must be deployed in the Organization Root Account and in us-east-1 region as Cur2.0 is only available in the organization Root account and region us-east-1.

Parameters:
  BlocksResourceName:
    Type: String
    Default: 'blocks-cur-data'
    Description: 'Prefix if creating a new bucket; stack suffixes with account and region'
  BlocksExternalAccountId:
    Type: String
    Default: "503132503926"
    Description: The 12-digit AWS account ID of the Blocks external account that will be trusted.
  ExternalId:
    Type: String
    NoEcho: true
    Default: "blocks-shared-secret"
    Description: 'Shared secret required in sts:AssumeRole (set per customer if you want)'
  KmsKeyArn:
    Type: String
    Default: ''
    Description: 'Optional AWS KMS master key ARN for bucket encryption; if set, also update the CMK key policy to allow S3 and bcm-data-exports'
  StackSetName:
    Type: String
    Default: 'Blocks-Subaccounts-IAM-Role'
    Description: 'The name for the CloudFormation StackSet that deploys IAM role to sub-accounts.'
  SubAccountsStacksetTemplateUrl:
    Type: String
    Default: 'https://blocks-cf-templates.s3.eu-north-1.amazonaws.com/Blocks-CF-Subaccounts-Template.yaml'
    Description: 'The URL for the StackSet template that creates IAM roles in sub-accounts.'
  OrganizationRootId:
    Type: String
    Description: 'AWS Organization Root OU ID (e.g., r-xxxx). Find this in AWS Organizations console.'
    AllowedPattern: '^r-[a-z0-9]{4,32}$'
    ConstraintDescription: 'Must be a valid Organization Root ID starting with r-'
  TemplateVersion:
    Type: String
    Default: '1.0.0'
    Description: 'Version of the template to force updates when the URL does not change.'
  EnableBackfill:
    Type: String
    AllowedValues: ["TRUE", "FALSE"]
    ConstraintDescription: 'Must be TRUE or FALSE'
    Description: "Set to TRUE if business support is enabled in your AWS account, This will create a support Case Request to backfill the data for the last 37 months"

Conditions:
  HasKms: !Not [!Equals [!Ref KmsKeyArn, '']]
  EnableBackfillCondition: !Equals [!Ref EnableBackfill, "TRUE"]

Rules:
  EnforceUsEast1:
    Assertions:
      - Assert:
          Fn::Equals:
            - !Ref AWS::Region
            - us-east-1
        AssertDescription: "You must deploy to region us-east-1 only. Since Data exports is only available in us-east-1"

Resources:
  CURBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${BlocksResourceName}-${AWS::AccountId}'
      OwnershipControls:
        Rules: [{ ObjectOwnership: BucketOwnerEnforced }]
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Status: Enabled
            ExpirationInDays: 30
            NoncurrentVersionExpirationInDays: 30
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 30
      VersioningConfiguration: { Status: Enabled }
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - !If
            - HasKms
            - { ServerSideEncryptionByDefault: { SSEAlgorithm: aws:kms, KMSMasterKeyID: !Ref KmsKeyArn } }
            - { ServerSideEncryptionByDefault: { SSEAlgorithm: AES256 } }

  CURBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CURBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:

          - Sid: AllowBCMDataExportsPut
            Effect: Allow
            Principal: { Service: bcm-data-exports.amazonaws.com }
            Action: s3:PutObject
            Resource: !Sub "arn:${AWS::Partition}:s3:::${CURBucket}/*"
            Condition:
              StringEquals: { aws:SourceAccount: !Ref AWS::AccountId }
              StringLike:
                aws:SourceArn: !Sub "arn:${AWS::Partition}:bcm-data-exports:us-east-1:${AWS::AccountId}:export/*"

          - Sid: AllowBCMDataExportsBucketMeta
            Effect: Allow
            Principal: { Service: bcm-data-exports.amazonaws.com }
            Action:
              - s3:GetBucketAcl
              - s3:GetBucketPolicy
              - s3:GetBucketLocation
              - s3:ListBucket
            Resource: !Sub "arn:${AWS::Partition}:s3:::${CURBucket}"
            Condition:
              StringEquals: { aws:SourceAccount: !Ref AWS::AccountId }
              StringLike:
                aws:SourceArn: !Sub "arn:${AWS::Partition}:bcm-data-exports:us-east-1:${AWS::AccountId}:export/*"

          - Sid: AllowReadRoleGetObject
            Effect: Allow
            Principal:
              AWS: !GetAtt BlocksReadRole.Arn
            Action: ['s3:GetObject']
            Resource: !Sub "arn:${AWS::Partition}:s3:::${CURBucket}/cur2/*"

  Cur20Export:
    Type: AWS::BCMDataExports::Export
    DependsOn: CURBucketPolicy
    Properties:
      Export:
        Name: !Sub '${BlocksResourceName}-${AWS::AccountId}'
        Description: 'CUR 2.0 export to S3 (Parquet), hourly with resource IDs'
        DataQuery:
          QueryStatement: |
            SELECT bill_bill_type, 
              bill_billing_entity, 
              bill_billing_period_end_date, 
              bill_billing_period_start_date, 
              bill_invoice_id, 
              bill_invoicing_entity, 
              bill_payer_account_id,
              bill_payer_account_name, 
              cost_category, 
              discount, 
              discount_bundled_discount, 
              discount_total_discount, 
              identity_line_item_id, 
              identity_time_interval, 
              line_item_availability_zone, 
              line_item_blended_cost, 
              line_item_blended_rate, 
              line_item_currency_code, 
              line_item_legal_entity, 
              line_item_line_item_description, 
              line_item_line_item_type, 
              line_item_net_unblended_cost, 
              line_item_net_unblended_rate, 
              line_item_normalization_factor, 
              line_item_normalized_usage_amount, 
              line_item_operation, 
              line_item_product_code, 
              line_item_resource_id, 
              line_item_tax_type, 
              line_item_unblended_cost, 
              line_item_unblended_rate, 
              line_item_usage_account_id, 
              line_item_usage_account_name, 
              line_item_usage_amount, 
              line_item_usage_end_date, 
              line_item_usage_start_date, 
              line_item_usage_type, 
              pricing_currency, 
              pricing_lease_contract_length, 
              pricing_offering_class, 
              pricing_public_on_demand_cost, 
              pricing_public_on_demand_rate, 
              pricing_purchase_option, 
              pricing_rate_code, 
              pricing_rate_id, 
              pricing_term, 
              pricing_unit, 
              product, 
              product_comment, 
              product_fee_code, 
              product_fee_description, 
              product_from_location, 
              product_from_location_type, 
              product_from_region_code, 
              product_instance_family,
              product_instance_type, 
              product_instancesku, 
              product_location, 
              product_location_type,
              product_operation, 
              product_pricing_unit, 
              product_product_family, 
              product_region_code,
              product_servicecode,
              product_sku,
              product_to_location, 
              product_to_location_type,
              product_to_region_code, 
              product_usagetype, 
              reservation_amortized_upfront_cost_for_usage, 
              reservation_amortized_upfront_fee_for_billing_period, 
              reservation_availability_zone, 
              reservation_effective_cost, 
              reservation_end_time, 
              reservation_modification_status, 
              reservation_net_amortized_upfront_cost_for_usage, 
              reservation_net_amortized_upfront_fee_for_billing_period, 
              reservation_net_effective_cost, 
              reservation_net_recurring_fee_for_usage,
              reservation_net_unused_amortized_upfront_fee_for_billing_period, 
              reservation_net_unused_recurring_fee, reservation_net_upfront_value, 
              reservation_normalized_units_per_reservation, 
              reservation_number_of_reservations,
              reservation_recurring_fee_for_usage, 
              reservation_reservation_a_r_n, 
              reservation_start_time,
              reservation_subscription_id,
              reservation_total_reserved_normalized_units, 
              reservation_total_reserved_units, 
              reservation_units_per_reservation, 
              reservation_unused_amortized_upfront_fee_for_billing_period,
              reservation_unused_normalized_unit_quantity, 
              reservation_unused_quantity,
              reservation_unused_recurring_fee, 
              reservation_upfront_value, 
              resource_tags, 
              savings_plan_amortized_upfront_commitment_for_billing_period, 
              savings_plan_end_time, savings_plan_instance_type_family, 
              savings_plan_net_amortized_upfront_commitment_for_billing_period, 
              savings_plan_net_recurring_commitment_for_billing_period, 
              savings_plan_net_savings_plan_effective_cost, 
              savings_plan_offering_type, 
              savings_plan_payment_option,
              savings_plan_purchase_term, 
              savings_plan_recurring_commitment_for_billing_period, 
              savings_plan_region, 
              savings_plan_savings_plan_a_r_n,
              savings_plan_savings_plan_effective_cost,
              savings_plan_savings_plan_rate, 
              savings_plan_start_time, 
              savings_plan_total_commitment_to_date,
              savings_plan_used_commitment, 
              split_line_item_actual_usage, 
              split_line_item_net_split_cost, 
              split_line_item_net_unused_cost, 
              split_line_item_parent_resource_id, 
              split_line_item_public_on_demand_split_cost,
              split_line_item_public_on_demand_unused_cost, 
              split_line_item_reserved_usage, 
              split_line_item_split_cost, 
              split_line_item_split_usage,
              split_line_item_split_usage_ratio, 
              split_line_item_unused_cost
            FROM COST_AND_USAGE_REPORT
          TableConfigurations:
            COST_AND_USAGE_REPORT:
              INCLUDE_MANUAL_DISCOUNT_COMPATIBILITY: 'FALSE'
              TIME_GRANULARITY: 'HOURLY'
              INCLUDE_RESOURCES: 'TRUE'
              INCLUDE_SPLIT_COST_ALLOCATION_DATA: 'TRUE'
        DestinationConfigurations:
          S3Destination:
            S3Bucket: !Ref CURBucket
            S3Prefix: 'cur2'
            S3Region: !Ref AWS::Region
            S3OutputConfigurations:
              Compression: PARQUET
              Format: PARQUET
              OutputType: CUSTOM
              Overwrite: OVERWRITE_REPORT
        RefreshCadence: { Frequency: SYNCHRONOUS }

  BlocksCustomResourceExecutionRole:
    Condition: EnableBackfillCondition
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::AccountId}-Blocks-backfill-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: lambda.amazonaws.com }
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CustomResourcePermissions
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
              - Effect: Allow
                Action:
                  - support:CreateCase
                  - support:DescribeServices
                  - support:DescribeSeverityLevels
                Resource: "*"

  BackfillRequesterFn:
    Condition: EnableBackfillCondition
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.12
      Handler: index.handler
      Role: !GetAtt BlocksCustomResourceExecutionRole.Arn
      Timeout: 120
      FunctionName: !Sub '${AWS::StackName}-BackfillRequesterFn'
      Environment:
        Variables:
          EXPORT_NAME: !Sub '${BlocksResourceName}-${AWS::AccountId}'
          BACKFILL_MONTHS: 37
          SEVERITY: 'low'
      Code:
        ZipFile: |
          import boto3, json, os, urllib.request, logging
          from botocore.exceptions import ClientError
          log = logging.getLogger()
          log.setLevel(logging.INFO)

          def send_response(event, context, status, reason=None, data=None, phys_id=None):
              try:
                  data = data or {}
                  if 'CaseId' not in data:
                      data['CaseId'] = ''
                  body = json.dumps({
                      'Status': status,
                      'Reason': (reason or 'OK')[:4096],
                      'PhysicalResourceId': phys_id or context.log_stream_name,
                      'StackId': event['StackId'],
                      'RequestId': event['RequestId'],
                      'LogicalResourceId': event['LogicalResourceId'],
                      'Data': data
                  }).encode('utf-8')
                  req = urllib.request.Request(event['ResponseURL'], data=body, method='PUT',
                                               headers={'content-type':'', 'content-length': str(len(body))})
                  with urllib.request.urlopen(req) as f:
                      f.read()
              except Exception:
                  log.exception("Failed sending CFN response")

          def handler(event, context):
              log.info("Event: %s", json.dumps(event))

              # Handle Delete event separately and exit early.
              if event['RequestType'] == 'Delete':
                  log.info("RequestType is Delete. No action to perform.")
                  send_response(event, context, 'SUCCESS', reason='No action on delete')
                  return

              # Handle Create/Update events
              status, reason, data, phys = 'SUCCESS', 'OK', {'CaseId': ''}, None
              try:
                  support = boto3.client('support', region_name='us-east-1')
                  export_name = os.environ['EXPORT_NAME']
                  months = int(os.environ.get('BACKFILL_MONTHS','12'))
                  severity = os.environ.get('SEVERITY','low')
                  try:
                      svc_code = "service-cost-and-usage-report-cur"
                      cat_code = "backfill-a-report"
                      issue_type = "customer-service"
                      language = "en"
                      subject = f"Request historical data backfill for CUR 2.0 export '{export_name}'"
                      body = (
                        f"Hello AWS Support,\n\n"
                        f"Please backfill {months} months of historical Cost and Usage Report data "
                        f"into the CUR 2.0 export named '{export_name}'.\n\n"
                        f"This export was created using AWS BCM Data Exports (CUR 2.0) and stores "
                        f"data in Parquet format.\n\n"
                        f"Thank you!"
                      )
                      resp = support.create_case(
                          subject=subject,
                          serviceCode=svc_code,
                          severityCode=severity,
                          categoryCode=cat_code,
                          communicationBody=body,
                          language=language,
                          issueType=issue_type,
                      )
                      phys = resp.get('caseId','unknown')
                      data.update({'CaseId': phys, 'BackfillRequested': True})
                  except ClientError as ce:
                      code = ce.response.get('Error',{}).get('Code','')
                      if code in ('SubscriptionRequiredException','AccessDeniedException') or 'AccessDenied' in code:
                          reason = f'Support API not available ({code}). Skipping backfill request.'
                          data.update({'BackfillRequested': False, 'Reason': reason})
                      else:
                          status = 'FAILED'
                          reason = f'Unexpected Support API error: {code}'
              except Exception as e:
                  status = 'FAILED'
                  reason = f'Unhandled error: {e}'
              finally:
                  send_response(event, context, status, reason, data, phys)

  RequestBackfill:
    Condition: EnableBackfillCondition
    Type: Custom::RequestCurBackfill
    DependsOn: Cur20Export
    Properties:
      ServiceToken: !GetAtt BackfillRequesterFn.Arn
      ExportName: !Sub '${BlocksResourceName}-${AWS::AccountId}'
      BackfillMonths: 37
      Severity: 'low'

  SubAccountStackSet:
    Type: AWS::CloudFormation::StackSet
    Properties:
      StackSetName: Blocks-SubAccounts
      Description: 'Deploy read-only roles to all sub-accounts (no CUR accounts)'
      PermissionModel: SERVICE_MANAGED
      AutoDeployment:
        Enabled: true
        RetainStacksOnAccountRemoval: false
      Capabilities:
        - CAPABILITY_NAMED_IAM
      TemplateURL: !Ref SubAccountsStacksetTemplateUrl
      StackInstancesGroup:
        - DeploymentTargets:
            OrganizationalUnitIds:
              - !Ref OrganizationRootId
          Regions:
            - us-east-1
      OperationPreferences:
        FailureTolerancePercentage: 100
        MaxConcurrentPercentage: 100
        RegionConcurrencyType: PARALLEL
      Tags:
        - Key: TemplateVersion
          Value: !Ref TemplateVersion
      CallAs: SELF

  CostAndReservationsReadPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub '${AWS::AccountId}-CostAndReservationsReadPolicy'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: CostAndUsageReadOnly
            Effect: Allow
            Action:
              - ce:Get*
              - ce:List*
              - ce:Describe*
              - cost-optimization-hub:Get*
              - cost-optimization-hub:List*
              - cur:Get*
              - cur:DescribeReportDefinitions
              - bcm-data-exports:GetExport
              - bcm-data-exports:ListExports
            Resource: "*"

          - Sid: PpaAndCreditsCheck
            Effect: Allow
            Action:
              - billing:GetBillingData
              - billing:GetBillingDetails
              - billing:GetCredits
            Resource: "*"

          - Sid: ReservationsReadOnly
            Effect: Allow
            Action:
              - elasticache:DescribeReserved*
              - redshift:DescribeReserved*
              - rds:DescribeReserved*
              - ec2:DescribeReserved*
            Resource: "*"

  SavingsEstimationReadOnly:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub '${AWS::AccountId}-SavingsEstimationReadOnlyPolicy'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: Ec2ReadOnly
            Effect: Allow
            Action:
              - ec2:Describe*
              - ec2:Get*
              - ec2:List*
              - dlm:Get*
              - elasticloadbalancing:Describe*
              - autoscaling:Describe*
              - autoscaling:Get*
              - autoscaling:List*
            Resource: "*"

          - Sid: LambdaReadOnly
            Effect: Allow
            Action:
              - lambda:List*
              - lambda:Get*
            Resource: "*"

          - Sid: EcsEksEcrReadOnly
            Effect: Allow
            Action:
              - ecs:List*
              - ecs:Describe*
              - eks:List*
              - eks:Describe*
              - ecr:DescribeRepositories
              - ecr:ListImages
              - ecr:DescribeImages
            Resource: "*"

          - Sid: RdsReadOnly
            Effect: Allow
            Action:
              - rds:Describe*
              - rds:List*
            Resource: "*"

          - Sid: DynamoDbReadOnly
            Effect: Allow
            Action:
              - dynamodb:List*
              - dynamodb:Describe*
            Resource: "*"

          - Sid: DynamoDBAcceleratorReadOnly
            Effect: Allow
            Action:
              - dax:DescribeClusters
              - dax:ListTags
              - dax:DescribeDefaultParameters
              - dax:DescribeParameters
            Resource: "*"

          - Sid: RedshiftReadOnly
            Effect: Allow
            Action:
              - redshift:Describe*
              - redshift:Get*
              - redshift:List*
            Resource: "*"

          - Sid: RedshiftServerlessReadOnly
            Effect: Allow
            Action:
              - redshift-serverless:Describe*
              - redshift-serverless:List*
            Resource: "*"

          - Sid: MemoryDBReadOnly
            Effect: Allow
            Action:
              - memorydb:Describe*
              - memorydb:List*
              - memorydb:ListTags
            Resource: "*"
          
          - Sid: AuroraDSQLReadOnly
            Effect: Allow
            Action:
              - dsql:Get*
              - dsql:List*
            Resource: "*"  

          - Sid: TimeStreamReadOnly
            Effect: Allow
            Action:
              - timestream:List*
              - timestream:Describe*
              - timestream:ListTagsForResource
              - timestream-influxdb:Get*
              - timestream-influxdb:List*
            Resource: "*"

          - Sid: TrustedAdvisorReadOnly
            Effect: Allow
            Action:
              - trustedadvisor:Describe*
              - trustedadvisor:Get*
              - trustedadvisor:List*
              - support:DescribeTrustedAdvisorChecks
              - support:DescribeTrustedAdvisorCheckResult
              - support:DescribeTrustedAdvisorCheckSummaries
              - support:DescribeTrustedAdvisorCheckRefreshStatuses
              - support:RefreshTrustedAdvisorCheck
            Resource: "*"

          - Sid: ElastiCacheReadOnly
            Effect: Allow
            Action:
              - elasticache:Describe*
              - elasticache:List*
            Resource: "*" 
 
          - Sid: S3ReadOnly
            Effect: Allow
            Action:
              - s3:List*
              - s3vectors:ListVectorBuckets
              - s3:GetLifecycleConfiguration
              - s3:GetBucketLocation
              - s3:GetObjectRetention
              - s3:GetBucketTagging
            Resource: "*"

          - Sid: CloudWatchReadOnly
            Effect: Allow
            Action:
              - cloudwatch:Describe*
              - cloudwatch:Get*
              - cloudwatch:List*
              - oam:ListSinks
              - logs:Describe*
              - logs:Get*
              - logs:List*
            Resource: "*"

  SavingsEstimationReadOnlyPart2:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub '${AWS::AccountId}-SavingsEstimationReadOnlyPolicyPart2'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: BackupReadOnly
            Effect: Allow
            Action:
              - backup:Describe*
              - backup:Get*
              - backup:List*
            Resource: "*"

          - Sid: AppAutoScalingReadOnly
            Effect: Allow
            Action:
              - application-autoscaling:Describe*
              - application-autoscaling:List*
              - application-autoscaling:Get*
              - autoscaling-plans:Describe*
              - autoscaling-plans:Get*
            Resource: "*"

          - Sid: ApiGwReadOnly
            Effect: Allow
            Action:
              - apigateway:GET
            Resource: "*"

          - Sid: ElasticSearchReadOnly
            Effect: Allow
            Action:
              - es:Describe*
              - es:List*
              - es:Get*
            Resource: "*"

          - Sid: WorkSpacesReadOnly
            Effect: Allow
            Action:
              - workspaces:Describe*
            Resource: "*"

          - Sid: FsxReadOnly
            Effect: Allow
            Action:
              - fsx:Describe*
              - fsx:List*
            Resource: "*"

          - Sid: EfsReadOnly
            Effect: Allow
            Action:
              - elasticfilesystem:Describe*
              - elasticfilesystem:List*
            Resource: "*"

          - Sid: AppstreamReadOnly
            Effect: Allow
            Action:
              - appstream:Describe*
              - appstream:List*
            Resource: "*"

          - Sid: SageMakerReadOnly
            Effect: Allow
            Action:
              - sagemaker:Describe*
              - sagemaker:List*
              - sagemaker:Search
            Resource: "*"

          - Sid: GlueReadOnly
            Effect: Allow
            Action:
              - Glue:Get*
              - Glue:List*
            Resource: "*"

          - Sid: BedrockReadOnly
            Effect: Allow
            Action:
              - bedrock:GetProvisionedModelThroughput
              - bedrock:ListProvisionedModelThroughputs
            Resource: "*"

          - Sid: CloudFrontReadOnly
            Effect: Allow
            Action:
              - cloudfront:Get*
              - cloudfront:List*
            Resource: "*"

          - Sid: ApprunnerReadOnly
            Effect: Allow
            Action:
              - apprunner:ListServices
              - apprunner:DescribeService
              - apprunner:ListAutoScalingConfigurations
              - apprunner:DescribeAutoScalingConfiguration
              - apprunner:ListTagsForResource
            Resource: "*"   

          - Sid: BatchReadOnly
            Effect: Allow
            Action:
              - batch:Get*
              - batch:List*
            Resource: "*"  

          - Sid: CodeBuildReadOnly
            Effect: Allow
            Action:
              - codebuild:ListProjects
              - codebuild:BatchGetProjects
              - codebuild:ListBuilds
              - codebuild:ListBuildsForProject
              - codebuild:ListTagsForResource
            Resource: "*"  

          - Sid: CodePipelineReadOnly
            Effect: Allow
            Action:
              - codepipeline:GetPipeline
              - codepipeline:ListPipelines
              - codepipeline:ListTagsForResource
            Resource: "*"  

          - Sid: KinesisReadOnly
            Effect: Allow
            Action:
              - kinesis:ListShards
              - kinesis:ListStreamConsumers
              - kinesis:ListStreams
              - kinesis:DescribeLimits
              - kinesis:DescribeStreamConsumer
              - kinesis:DescribeStreamSummary
              - kinesis:ListTagsForResource
            Resource: "*"  

          - Sid: KinesisAnalyticsReadOnly
            Effect: Allow
            Action:
              - kinesisanalytics:ListApplications
              - kinesisanalytics:DescribeApplication
              - kinesisanalytics:ListTagsForResource
            Resource: "*"  

          - Sid: FirehoseReadOnly
            Effect: Allow
            Action:
              - firehose:ListDeliveryStreams
              - firehose:DescribeDeliveryStream
              - firehose:ListTagsForDeliveryStream
            Resource: "*"  

          - Sid: GrafanaReadOnly
            Effect: Allow
            Action:
              - grafana:ListWorkspaces
              - grafana:DescribeWorkspace
              - grafana:DescribeWorkspaceConfiguration
              - grafana:ListTagsForResource
            Resource: "*"  

          - Sid: AirflowReadOnly
            Effect: Allow
            Action:
              - airflow:ListEnvironments
              - airflow:GetEnvironment
              - airflow:ListTagsForResource
            Resource: "*"  

          - Sid: NeptuneReadOnly
            Effect: Allow
            Action:
              - neptune:DescribeDBClusters
              - neptune:DescribeDBInstances
              - neptune:DescribeDBClusterSnapshots
              - neptune:DescribeDBParameterGroups
              - neptune:DescribeDBClusterParameterGroups
              - neptune:ListTagsForResource
              - neptune-graph:GetEngineStatus
              - neptune-graph:GetGraphSummary
              - neptune-db:GetEngineStatus
              - neptune-db:GetGraphSummary
            Resource: "*"  

          - Sid: WafReadOnly
            Effect: Allow
            Action:
              - wafv2:ListWebACLs
              - wafv2:GetWebACL
              - wafv2:GetWebACLForResource
              - wafv2:ListResourcesForWebACL
              - wafv2:ListTagsForResource
            Resource: "*"  

  BlocksReadRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::AccountId}-Blocks-read-role'
      MaxSessionDuration: 3600
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:${AWS::Partition}:iam::${BlocksExternalAccountId}:root'
            Action: 'sts:AssumeRole'
            Condition:
              StringEquals:
                'sts:ExternalId': !Ref ExternalId

      ManagedPolicyArns:
        - !Ref CostAndReservationsReadPolicy
        - !Ref SavingsEstimationReadOnly
        - !Ref SavingsEstimationReadOnlyPart2
        - !Sub arn:${AWS::Partition}:iam::aws:policy/ComputeOptimizerReadOnlyAccess
        - !Sub arn:${AWS::Partition}:iam::aws:policy/AWSOrganizationsReadOnlyAccess
        - !Sub arn:${AWS::Partition}:iam::aws:policy/AWSSavingsPlansReadOnlyAccess
        - !Sub arn:${AWS::Partition}:iam::aws:policy/AWSResourceGroupsReadOnlyAccess

      Policies:
        - PolicyName: StsWhoami
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sts:GetCallerIdentity
                Resource: "*"

        # CUR S3 Bucket Access - RESTRICTED to cur2/* prefix only
        - PolicyName: CurS3Read
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ListCurPrefix
                Effect: Allow
                Action: 's3:ListBucket'
                Resource: !Sub "arn:${AWS::Partition}:s3:::${CURBucket}"
                Condition:
                  StringLike:
                    s3:prefix: ['cur2/*']
              - Sid: ReadCurObjects
                Effect: Allow
                Action: 's3:GetObject'
                Resource: !Sub "arn:${AWS::Partition}:s3:::${CURBucket}/cur2/*"

        # KMS Decrypt for Encrypted CUR Bucket
        - !If
          - HasKms
          - PolicyName: CurKmsDecrypt
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - kms:Decrypt
                    - kms:DescribeKey
                  Resource: !Ref KmsKeyArn
          - !Ref 'AWS::NoValue'

Outputs:
  CURBucketName:
    Description: 'Name of the S3 bucket storing CUR data'
    Value: !Ref CURBucket
  CURBucketArn:
    Value:
      !Sub "arn:${AWS::Partition}:s3:::${CURBucket}"
  BackfillCaseId:
    Condition: EnableBackfillCondition
    Description: 'Present if Support API allowed; empty otherwise'
    Value: !GetAtt RequestBackfill.CaseId
  BlocksReadRoleArn:
    Description: 'Cross-account role ARN with read-only access to CUR S3 data, billing services, and 40+ AWS services for complete cost visibility and optimization'
    Value: !GetAtt BlocksReadRole.Arn
  BlocksReadRoleName:
    Description: 'Cross-account role Name with read-only access to CUR S3 data, billing services, and 40+ AWS services for complete cost visibility and optimization'
    Value: !Ref BlocksReadRole
  ImportantNotes:
    Value: 'Deploy in us-east-1. Role includes 40+ AWS services for complete cost optimization analysis.'
  NextSteps:
    Description: "Instructions for completing setup"
    Value: !If
      - EnableBackfillCondition
      - "Backfill support case created. Please wait for AWS Support to process your request."
      - !Sub |
          To request historical data backfill, open an AWS Support case.

          Use the following details for the support request:

          Subject:
          Request historical data backfill for CUR 2.0 export ${BlocksResourceName}-${AWS::AccountId}

          Body:
          Hello AWS Support,

          We are requesting assistance with backfilling a CUR 2.0 Data Export according to the requirements below.

          Please backfill the existing ${BlocksResourceName}-${AWS::AccountId} report from the:
          s3://${CURBucket}/cur2/${BlocksResourceName}-${AWS::AccountId}/data
          S3 bucket.

          We need historical data for the following period: 01.01.2022 through the current date.

          Thank you.